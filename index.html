<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Chat - Android OK</title>
    <style>
        :root { --p: #667eea; --bg: #0b0b1a; --c: #16162d; --txt: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--txt); height: 100vh; display: flex; flex-direction: column; }
        
        /* Ajustes para celular */
        .header { background: var(--p); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .admin-btn { background: rgba(0,0,0,0.3); border: none; color: white; padding: 10px; border-radius: 8px; font-size: 14px; }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 12px; border-radius: 12px; font-size: 16px; line-height: 1.4; }
        .msg.user { align-self: flex-end; background: var(--p); }
        .msg.bot { align-self: flex-start; background: var(--c); border: 1px solid #2a2a4a; }

        .input-area { padding: 15px; background: var(--c); display: flex; gap: 8px; }
        textarea { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; resize: none; font-size: 16px; }
        .send-btn { background: var(--p); border: none; color: white; padding: 0 15px; border-radius: 10px; font-weight: bold; }

        /* Modal Pantalla Completa para Android */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1000; flex-direction: column; padding: 20px; }
        .modal.active { display: flex; }
        input, select { width: 100%; margin: 15px 0; padding: 12px; background: #111; color: white; border: 1px solid #444; border-radius: 8px; font-size: 16px; }
        .btn-save { background: var(--p); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div class="header">
    <strong>ü§ñ MI IA</strong>
    <button class="admin-btn" onclick="openCfg()">‚öôÔ∏è AJUSTES</button>
</div>

<div class="chat-container" id="chat">
    <div id="welcome" style="text-align:center; padding: 40px 20px;">
        <h3>¬°Bienvenido!</h3>
        <p style="color:#888; margin-top:10px;">Configura tu API Key en Ajustes para empezar a chatear.</p>
    </div>
</div>

<div class="input-area">
    <textarea id="uInput" placeholder="Escribe aqu√≠..." rows="1"></textarea>
    <button class="send-btn" onclick="send()">ENVIAR</button>
</div>

<!-- CONFIGURACI√ìN -->
<div class="modal" id="mCfg">
    <h2 style="margin-bottom:20px;">Configuraci√≥n</h2>
    
    <label>Tu Groq API Key:</label>
    <input type="password" id="mKey" placeholder="Pega tu gsk_ aqu√≠">
    
    <label>Modelo de Inteligencia:</label>
    <select id="mModel">
        <option value="llama-3.1-8b-instant">Llama 3.1 8B (R√°pido)</option>
        <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Potente)</option>
    </select>

    <button class="btn-save" onclick="saveCfg()">GUARDAR Y EMPEZAR</button>
    <button onclick="closeCfg()" style="background:none; color:#888; border:none; margin-top:20px; text-decoration:underline;">Cerrar sin guardar</button>
</div>

<script>
    // --- LIMPIEZA NUCLEAR PARA ANDROID ---
    // Esto borra memorias de c√≥digos anteriores que tengan el error
    if (localStorage.getItem('ia_pro_config')) {
        let old = JSON.parse(localStorage.getItem('ia_pro_config'));
        if (old.model && old.model.includes('8192')) {
            localStorage.clear(); // Borrado total si detecta el error viejo
            console.log("Memoria corrupta borrada.");
        }
    }

    let CONFIG = {
        key: '',
        model: 'llama-3.1-8b-instant',
        history: []
    };

    // Cargar datos limpios
    window.onload = () => {
        const saved = localStorage.getItem('ia_clean_v2');
        if (saved) {
            CONFIG = JSON.parse(saved);
        }
    };

    async function send() {
        const input = document.getElementById('uInput');
        const text = input.value.trim();
        
        if (!text) return;
        if (!CONFIG.key) return alert("Primero pon tu API Key en Ajustes");

        document.getElementById('welcome').style.display = 'none';
        addUI('user', text);
        CONFIG.history.push({ role: 'user', content: text });
        input.value = '';

        try {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${CONFIG.key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: CONFIG.model,
                    messages: [
                        { role: 'system', content: 'Responde en espa√±ol de forma √∫til.' },
                        ...CONFIG.history.slice(-6)
                    ]
                })
            });

            const data = await res.json();
            
            if (data.choices) {
                const responseText = data.choices[0].message.content;
                addUI('bot', responseText);
                CONFIG.history.push({ role: 'assistant', content: responseText });
                save();
            } else {
                // Si el error persiste, lo veremos aqu√≠ escrito en el chat
                addUI('bot', "‚ùå ERROR DE GROQ: " + data.error.message);
            }
        } catch (e) {
            addUI('bot', "‚ùå Error de conexi√≥n. Verifica tu internet.");
        }
    }

    function addUI(role, txt) {
        const d = document.createElement('div');
        d.className = `msg ${role}`;
        d.innerText = txt;
        const c = document.getElementById('chat');
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    function openCfg() {
        document.getElementById('mKey').value = CONFIG.key;
        document.getElementById('mModel').value = CONFIG.model;
        document.getElementById('mCfg').classList.add('active');
    }

    function closeCfg() { document.getElementById('mCfg').classList.remove('active'); }

    function saveCfg() {
        CONFIG.key = document.getElementById('mKey').value.trim();
        CONFIG.model = document.getElementById('mModel').value;
        save();
        closeCfg();
        alert("Configuraci√≥n guardada. ¬°Ya puedes chatear!");
    }

    function save() {
        localStorage.setItem('ia_clean_v2', JSON.stringify(CONFIG));
    }
</script>
</body>
</html>
